<!DOCTYPE html>
<html lang="vi"> <!-- Default language Vietnamese -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokédex Nâng Cao</title> <!-- Title will be updated by JS -->
    <style>
        :root {
            --primary-color: #e74c3c; --secondary-color: #f1f1f1; --dark-color: #333;
            --accent-color: #3498db; --light-color: #feca1b; --grass: #78c850;
            --poison: #a040a0; --fire: #f08030; --flying: #a890f0; --water: #6890f0;
            --bug: #a8b820; --normal: #a8a878; --electric: #f8d030; --ground: #e0c068;
            --fairy: #ee99ac; --fighting: #c03028; --psychic: #f85888; --rock: #b8a038;
            --steel: #b8b8d0; --ice: #98d8d8; --ghost: #705898; --dragon: #7038f8;
            --dark: #705848;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9e9e9; padding: 20px; color: var(--dark-color); line-height: 1.5; padding-bottom: 80px; /* Add padding for comparison bar */ }
        .container { max-width: 1300px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary-color), #c0392b); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .header h1 { font-size: 2.6rem; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); }
        .header p { font-size: 1rem; opacity: 0.9; }

        /* Controls Section */
        .controls { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 25px; background-color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); gap: 15px; }
        .search-container, .filter-container, .sort-container, .lang-container { margin: 5px 0; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;}
        .controls input, .controls select, .controls button { padding: 11px 14px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; outline-color: var(--accent-color); }
        .controls input { flex-grow: 1; min-width: 180px; }
        .controls button { background-color: var(--accent-color); color: white; cursor: pointer; transition: background-color 0.2s; border: none; font-weight: 500; }
        .controls button:hover { background-color: #2980b9; }
        #load-more-btn { display: block; margin: 35px auto; padding: 14px 30px; font-size: 1.15rem; background-color: var(--primary-color); font-weight: bold; border-radius: 8px; color: white;}
        #load-more-btn:hover { background-color: #c0392b; }
        #load-more-btn:disabled { background-color: #ccc; cursor: not-allowed; color: #666;}
        #favorites-filter-btn.active { background-color: #2ecc71; font-weight: bold; }
        #lang-switcher { background-color: #6c757d; font-weight: bold; min-width: 110px; padding: 12px 15px; font-size: 1rem;}
        #lang-switcher:hover { background-color: #5a6268; }

        /* Pokedex Grid & Cards */
        .pokedex { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 25px; }
        .pokemon-card { background-color: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; position: relative; display: flex; flex-direction: column;}
        .pokemon-card:hover { transform: translateY(-6px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); }
        .card-icons { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 10;}
        .favorite-icon, .compare-icon { font-size: 1.6rem; color: rgba(0,0,0,0.2); cursor: pointer; transition: color 0.2s, transform 0.2s; background-color: rgba(255, 255, 255, 0.8); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; line-height: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .favorite-icon:hover, .compare-icon:hover { transform: scale(1.15); color: rgba(0, 0, 0, 0.4); }
        .favorite-icon.favorited { color: var(--primary-color); }
        .compare-icon.selected { color: var(--accent-color); background-color: rgba(52, 152, 219, 0.2); }
        .compare-icon { font-size: 1.5rem; }
        .pokemon-image { background-color: var(--secondary-color); height: 180px; display: flex; justify-content: center; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .pokemon-image img { max-width: 95%; max-height: 140px; transition: transform 0.3s; image-rendering: pixelated; object-fit: contain; }
        .pokemon-card:hover .pokemon-image img { transform: scale(1.12); }
        .pokemon-info { padding: 15px 15px 20px 15px; text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .pokemon-id { background-color: var(--light-color); color: var(--dark-color); border-radius: 20px; padding: 4px 14px; font-size: 0.85rem; display: inline-block; margin-bottom: 10px; font-weight: bold; }
        .pokemon-name { font-size: 1.5rem; margin-bottom: 12px; color: var(--dark-color); text-transform: capitalize; font-weight: 600; padding-right: 40px; }
        .pokemon-types { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-top: auto; }
        .pokemon-type { padding: 5px 14px; border-radius: 15px; font-size: 0.8rem; color: white; text-transform: uppercase; font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); z-index: 1000; overflow: auto; padding: 20px; backdrop-filter: blur(4px); }
        .modal-content { background-color: white; margin: 4% auto; padding: 30px 35px; border-radius: 15px; max-width: 850px; position: relative; animation: modalSlideIn 0.5s ease-out; }
        .close-btn { position: absolute; top: 15px; right: 25px; font-size: 2.8rem; color: #aaa; cursor: pointer; transition: color 0.2s; line-height: 1; z-index: 1001; }
        .close-btn:hover { color: var(--primary-color); }
        .modal-header { display: flex; align-items: center; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px solid #eee; }
        .modal-pokemon-image-container { display: flex; flex-direction: column; align-items: center; margin-right: 30px; }
        .modal-pokemon-image { width: 180px; height: 180px; background-color: var(--secondary-color); border-radius: 50%; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 5px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.15); margin-bottom: 12px; }
        .modal-pokemon-image img { max-width: 90%; max-height: 90%; image-rendering: pixelated; object-fit: contain; }
        #play-cry-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--accent-color); transition: color 0.2s, transform 0.2s; margin-top: 5px; }
        #play-cry-btn:hover { color: #2980b9; transform: scale(1.1); }
        .modal-pokemon-info h2 { font-size: 2.4rem; margin-bottom: 8px; text-transform: capitalize; font-weight: 600; }
        .modal-pokemon-id { font-size: 1.4rem; color: #777; margin-bottom: 15px; }
        .modal-pokemon-types { display: flex; gap: 12px; flex-wrap: wrap; }
        .modal-pokemon-types .pokemon-type { font-size: 0.85rem; padding: 6px 15px; }
        #legendary-mythical-badge { font-size: 0.7rem; font-weight: bold; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; color: white; margin-left: 5px; vertical-align: middle; }
        #legendary-mythical-badge.legendary { background-color: #d4af37; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        #legendary-mythical-badge.mythical { background-color: #ab47bc; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }

        /* Modal Tabs & Content */
        .modal-tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-link { padding: 12px 18px; cursor: pointer; border: none; background: none; font-size: 1.05rem; border-bottom: 3px solid transparent; transition: border-color 0.3s, color 0.3s; color: #777; font-weight: 500; white-space: nowrap; }
        .tab-link.active { border-bottom-color: var(--primary-color); font-weight: bold; color: var(--dark-color); }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
        .details-grid, .stats-weaknesses-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .modal-section-title { margin-bottom: 18px; color: var(--accent-color); font-size: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 8px; font-weight: 600; }
        .stat-bar { margin-bottom: 14px; } .stat-name { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.95rem; } .stat-name span:first-child { font-weight: bold; text-transform: capitalize; } .stat-name span:last-child { color: #555; font-weight: bold; } .progress-bar { height: 14px; background-color: #eee; border-radius: 7px; overflow: hidden; } .progress { height: 100%; background-color: var(--accent-color); transition: width 0.5s ease-out; display: flex; align-items: center; justify-content: flex-end; font-size: 0.75rem; color: white; padding-right: 6px; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); } .progress.hp { background-color: #ff5959; } .progress.attack { background-color: #f5ac78; } .progress.defense { background-color: #fae078; color: #555; text-shadow: none; } .progress.special-attack { background-color: #9db7f5; } .progress.special-defense { background-color: #a7db8a; } .progress.speed { background-color: #fa92b2; }
        .detail-row { display: flex; margin-bottom: 12px; font-size: 1rem; line-height: 1.5; } .detail-label { width: 160px; font-weight: bold; color: var(--dark-color); flex-shrink: 0; } .detail-value { color: #555; text-transform: capitalize; }
        .weakness-section { margin-bottom: 18px; } .weakness-section h4 { font-size: 1.05rem; margin-bottom: 10px; color: var(--dark-color); font-weight: 600; } .weakness-types { display: flex; flex-wrap: wrap; gap: 10px; } .weakness-types .pokemon-type { font-size: 0.75rem; padding: 4px 12px; }
        .evolution-chain { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 20px 30px; } .evolution-stage { text-align: center; cursor: pointer; transition: opacity 0.2s, transform 0.2s; padding: 10px; border-radius: 10px; } .evolution-stage:hover { opacity: 0.85; transform: scale(1.03); background-color: #f9f9f9; } .evolution-stage img { width: 140px; height: 140px; background-color: var(--secondary-color); border-radius: 10px; padding: 10px; object-fit: contain; border: 1px solid #eee; box-shadow: 0 3px 6px rgba(0,0,0,0.08); margin-bottom: 5px; } .evolution-stage p { font-size: 1rem; margin-top: 10px; text-transform: capitalize; font-weight: bold; } .evolution-detail { font-size: 0.85rem; color: #666; margin-top: 5px; min-height: 1.2em; } .evolution-arrow { font-size: 2.2rem; color: #ccc; margin: 0 15px; align-self: center; }
        .flavor-text { font-style: italic; color: #555; line-height: 1.7; max-height: 120px; overflow-y: auto; padding: 5px 10px 5px 0; font-size: 1rem; background-color: #fdfdfd; border-left: 3px solid var(--accent-color); padding-left: 15px; border-radius: 0 5px 5px 0;}
        .ability-name-clickable { cursor: pointer; text-decoration: underline dotted; text-decoration-color: var(--accent-color); color: var(--accent-color); font-weight: normal; transition: color 0.2s; }
        .ability-name-clickable:hover { color: #2980b9; }
        #wiki-link { color: var(--accent-color); text-decoration: none; font-weight: 500; transition: color 0.2s;}
        #wiki-link:hover { color: #2980b9; text-decoration: underline;}

        /* Moves Tab Styles */
        #moves-content { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .moves-list { list-style: none; padding: 0; margin: 0; column-count: 2; column-gap: 25px; }
        .move-item { margin-bottom: 10px; padding: 5px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; break-inside: avoid-column; cursor: pointer; transition: background-color 0.1s ease; }
        .move-item:hover { background-color: #f0f8ff; }
        .move-name { text-transform: capitalize; color: var(--dark-color); margin-right: 10px; pointer-events: none; }
        .move-level { font-size: 0.85rem; color: #888; background-color: #f0f0f0; padding: 2px 6px; border-radius: 4px; white-space: nowrap; pointer-events: none; }
        .no-moves-found { color: #888; font-style: italic; }

        /* Tooltips */
        #move-tooltip, #ability-tooltip { position: absolute; background-color: rgba(40, 40, 40, 0.9); color: white; padding: 10px 15px; border-radius: 6px; font-size: 0.9rem; z-index: 1010; display: none; min-width: 200px; max-width: 350px; box-shadow: 0 3px 8px rgba(0,0,0,0.3); border: 1px solid rgba(255, 255, 255, 0.2); pointer-events: none; }
        #move-tooltip h4, #ability-tooltip h4 { margin: 0 0 8px 0; font-size: 1.1em; color: var(--light-color); text-transform: capitalize; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 5px; }
        #move-tooltip p, #ability-tooltip p { margin: 5px 0; line-height: 1.4; }
        #move-tooltip strong { color: #aaa; min-width: 80px; display: inline-block; }
        #move-tooltip .pokemon-type { margin-left: 5px; vertical-align: middle; font-size: 0.75em; padding: 2px 8px; }

        /* Comparison Bar & Modal Styles */
        #comparison-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(51, 51, 51, 0.95); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 999; box-shadow: 0 -3px 10px rgba(0,0,0,0.2); transform: translateY(100%); transition: transform 0.3s ease-in-out; flex-wrap: wrap; gap: 10px; }
        #comparison-bar.visible { transform: translateY(0); }
        #comparison-slots { display: flex; align-items: center; gap: 10px; flex-grow: 1; min-height: 40px; }
        .comparison-slot-item { display: flex; align-items: center; background-color: rgba(255, 255, 255, 0.1); padding: 5px 8px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s; border: 1px solid rgba(255,255,255,0.2); }
        .comparison-slot-item:hover { background-color: rgba(255, 255, 255, 0.2); }
        .comparison-slot-item img { width: 30px; height: 30px; margin-right: 8px; image-rendering: pixelated; background-color: rgba(255, 255, 255, 0.1); border-radius: 50%; }
        .comparison-slot-item span { text-transform: capitalize; }
        #comparison-actions button { margin-left: 10px; padding: 8px 15px; font-size: 0.9rem; }
        #compare-now-btn { background-color: var(--light-color); color: var(--dark-color); font-weight: bold; }
        #compare-now-btn:disabled { background-color: #aaa; color: #eee; cursor: not-allowed; opacity: 0.7; }
        #clear-comparison-btn { background-color: var(--primary-color); }
        #clear-comparison-btn:hover { background-color: #c0392b; }
        #comparison-modal .modal-content { max-width: 1000px; } .comparison-title { text-align: center; margin-bottom: 30px; font-size: 1.8rem; color: var(--primary-color); font-weight: bold;} #comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; } .compare-column { border: 1px solid #eee; border-radius: 10px; padding: 20px; background-color: #fdfdfd; } .compare-column .modal-section-title { text-align: center; } .compare-header { text-align: center; margin-bottom: 20px; } .compare-header img { width: 150px; height: 150px; object-fit: contain; background-color: var(--secondary-color); border-radius: 8px; padding: 10px; margin-bottom: 10px; } .compare-header h3 { font-size: 1.5rem; text-transform: capitalize; margin-bottom: 5px; } .compare-header .pokemon-id { background-color: var(--light-color); color: var(--dark-color); border-radius: 20px; padding: 3px 12px; font-size: 0.9rem; display: inline-block; margin-bottom: 10px; font-weight: bold; } .compare-header .pokemon-types { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; } .compare-column .stats-container { margin-top: 20px; } .compare-column .stat-name { font-size: 0.9rem; }

        /* Loading Placeholders & Spinner */
        .loading-placeholder { color: #aaa; font-style: italic; padding: 10px 0; }
        .loading { text-align: center; padding: 60px; color: #777; }
        .spinner { width: 55px; height: 55px; border: 6px solid var(--secondary-color); border-top: 6px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Type Colors */
        .normal { background-color: var(--normal); } .fire { background-color: var(--fire); } .water { background-color: var(--water); } .electric { background-color: var(--electric); } .grass { background-color: var(--grass); } .ice { background-color: var(--ice); } .fighting { background-color: var(--fighting); } .poison { background-color: var(--poison); } .ground { background-color: var(--ground); } .flying { background-color: var(--flying); } .psychic { background-color: var(--psychic); } .bug { background-color: var(--bug); } .rock { background-color: var(--rock); } .ghost { background-color: var(--ghost); } .dragon { background-color: var(--dragon); } .dark { background-color: var(--dark); } .steel { background-color: var(--steel); } .fairy { background-color: var(--fairy); }

        /* Responsive */
        @media (max-width: 900px) { #comparison-container { grid-template-columns: 1fr; gap: 25px; } #comparison-modal .modal-content { max-width: 550px; } .compare-column { padding: 15px; } }
        @media (max-width: 768px) {
             body { padding-bottom: 100px; } .header h1 { font-size: 2.2rem; } .header p { font-size: 0.9rem; }
             .controls { flex-direction: column; align-items: stretch; } .controls input, .controls select, .controls button { width: 100%; margin-bottom: 12px; }
             .pokedex { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
             .pokemon-name { font-size: 1.2rem; padding-right: 35px;}
             .modal-content { padding: 20px; margin: 8% auto; max-width: 95%; }
             .modal-header { flex-direction: column; text-align: center; } .modal-pokemon-image-container { margin-right: 0; margin-bottom: 20px; } .modal-pokemon-image { width: 150px; height: 150px; } .modal-pokemon-info h2 { font-size: 2rem; }
             .details-grid, .stats-weaknesses-grid { grid-template-columns: 1fr; gap: 20px;}
             .modal-tabs { flex-wrap: wrap; justify-content: center;} .tab-link { padding: 10px 12px; font-size: 0.95rem; }
             .evolution-chain { flex-direction: column; } .evolution-arrow { transform: rotate(90deg); margin: 15px 0; } .evolution-stage img { width: 110px; height: 110px; }
             #comparison-bar { padding: 10px; } #comparison-slots { margin-bottom: 10px; justify-content: center; flex-wrap: wrap; } .comparison-slot-item { flex-basis: 45%; justify-content: center; } #comparison-actions { display: flex; justify-content: space-around; width: 100%; } #comparison-actions button { margin: 0 5px; flex-grow: 1; }
             .moves-list { column-count: 1; }
         }
         @media (max-width: 480px) {
             body { padding-bottom: 120px; }
             .pokedex { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
             .pokemon-card { border-radius: 10px; } .pokemon-image { height: 130px; } .pokemon-image img { max-height: 90px; } .pokemon-name { font-size: 1.1rem; margin-bottom: 8px;} .pokemon-id { padding: 2px 10px; font-size: 0.75rem; margin-bottom: 6px;} .pokemon-type { padding: 3px 10px; font-size: 0.7rem; }
             .modal-pokemon-image { width: 130px; height: 130px; } .modal-pokemon-info h2 { font-size: 1.7rem; }
             .evolution-stage img { width: 100px; height: 100px; }
             #comparison-slots { gap: 5px; } .comparison-slot-item { flex-basis: 100%; }
         }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-translate-key="headerTitle">Pokédex Nâng Cao</h1>
            <p data-translate-key="headerSubtitle">Khám phá thế giới Pokémon kỳ diệu!</p>
        </div>

        <!-- Controls Section -->
        <div class="controls">
            <div class="search-container"> <input type="text" id="search-input" data-translate-key="searchPlaceholder" placeholder="Tìm theo Tên hoặc ID..."> </div>
            <div class="filter-container"> <select id="type-filter"> <option value="" data-translate-key="filterByType">Lọc theo Hệ...</option> </select> <button id="favorites-filter-btn" data-translate-key="showFavoritesBtn">Hiện Yêu Thích</button> </div>
            <div class="sort-container"> <select id="sort-order"> <option value="id" data-translate-key="sortById">Sắp xếp theo ID</option> <option value="name" data-translate-key="sortByName">Sắp xếp theo Tên (A-Z)</option> </select> </div>
            <div class="lang-container"> <button id="lang-switcher">English</button> </div>
        </div>

        <!-- Pokedex Grid -->
        <div class="pokedex" id="pokedex-container">
            <div class="loading"> <div class="spinner"></div> <p data-translate-key="loadingPokemon">Đang tải Pokémon...</p> </div>
        </div>

        <button id="load-more-btn" data-translate-key="loadMoreBtn">Tải thêm Pokémon</button>
    </div>

    <!-- Single Pokémon Detail Modal -->
    <div class="modal" id="pokemon-modal">
        <div class="modal-content">
            <span class="close-btn" id="close-modal">&times;</span>
            <div class="modal-header">
                <div class="modal-pokemon-image-container"> <div class="modal-pokemon-image"> <img id="modal-pokemon-img" src="" alt="Pokemon Image"> </div> <button id="play-cry-btn" data-translate-key="playCryBtnTitle" title="Phát tiếng kêu">🔊</button> </div>
                <div class="modal-pokemon-info">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;"> <h2 id="modal-pokemon-name"></h2> <span id="legendary-mythical-badge" style="display: none;"></span> </div>
                    <div class="modal-pokemon-id" id="modal-pokemon-id"></div>
                    <div class="modal-pokemon-types" id="modal-pokemon-types"></div>
                </div>
            </div>
            <div class="modal-tabs">
                 <button class="tab-link active" data-tab="details" data-translate-key="tabDetails">Chi tiết</button>
                 <button class="tab-link" data-tab="stats" data-translate-key="tabStats">Chỉ số & Điểm yếu</button>
                 <button class="tab-link" data-tab="evolution" data-translate-key="tabEvolution">Tiến hóa</button>
                 <button class="tab-link" data-tab="moves" data-translate-key="tabMoves">Tuyệt chiêu</button>
                 <button class="tab-link" data-tab="flavor" data-translate-key="tabFlavor">Mô tả</button>
            </div>
            <div id="tab-details" class="tab-content active">
                 <div class="details-grid">
                     <div class="details-container"> <h3 class="modal-section-title" data-translate-key="sectionPhysical">Đặc điểm Thể chất</h3> <div id="physical-details-content"><div class="loading-placeholder" data-translate-key="loadingText">Đang tải...</div></div> </div>
                     <div class="details-container"> <h3 class="modal-section-title" data-translate-key="sectionTrainingAndMore">Thông tin Huấn luyện & Khác</h3> <div id="training-details-content"></div> <div id="other-details-content" style="margin-top: 15px; border-top: 1px dashed #eee; padding-top: 15px;"></div> </div>
                 </div>
                 <!-- Wiki Link -->
                 <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;"> <a id="wiki-link" href="#" target="_blank" rel="noopener noreferrer" style="display: none;" data-translate-key="learnMoreWiki">Tìm hiểu thêm trên Bulbapedia</a> </div>
            </div>
            <div id="tab-stats" class="tab-content"> <div class="stats-weaknesses-grid"> <div class="stats-container"> <h3 class="modal-section-title" data-translate-key="sectionStats">Chỉ số Cơ bản</h3> <div id="stats-content"><div class="loading-placeholder" data-translate-key="loadingText">Đang tải...</div></div> </div> <div class="weakness-container"> <h3 class="modal-section-title" data-translate-key="sectionTypeMatchups">Tương tác Hệ</h3> <div id="weakness-content"><div class="loading-placeholder" data-translate-key="loadingText">Đang tải...</div></div> </div> </div> </div>
            <div id="tab-evolution" class="tab-content"> <div class="evolution-container"> <h3 class="modal-section-title" data-translate-key="sectionEvolution">Chuỗi Tiến hóa</h3> <div id="evolution-content" class="evolution-chain"><div class="loading-placeholder" data-translate-key="loadingText">Đang tải...</div></div> </div> </div>
            <div id="tab-moves" class="tab-content"> <div class="moves-container"> <h3 class="modal-section-title" data-translate-key="sectionMoves">Tuyệt chiêu (Lên cấp)</h3> <div id="moves-content"><div class="loading-placeholder" data-translate-key="loadingText">Đang tải...</div></div> </div> </div>
            <div id="tab-flavor" class="tab-content"> <div class="flavor-text-container"> <h3 class="modal-section-title" data-translate-key="sectionPokedexEntry">Mô tả Pokédex</h3> <p id="flavor-text-content" class="flavor-text"><span class="loading-placeholder" data-translate-key="loadingText">Đang tải...</span></p> </div> </div>
        </div>
    </div>

    <!-- Comparison Bar -->
    <div id="comparison-bar"> <div id="comparison-slots"> <span data-translate-key="comparePrompt">Chọn Pokémon để so sánh...</span> </div> <div id="comparison-actions"> <button id="compare-now-btn" disabled data-translate-key="compareNowBtn">So sánh Ngay!</button> <button id="clear-comparison-btn" data-translate-key="clearBtn">Xóa</button> </div> </div>
    <!-- Comparison Modal -->
    <div class="modal" id="comparison-modal"> <div class="modal-content comparison-modal-content"> <span class="close-btn" id="close-comparison-modal">&times;</span> <h2 class="comparison-title" data-translate-key="comparisonTitle">So sánh Pokémon</h2> <div id="comparison-container"> <div class="compare-column" id="compare-col-1"> <div class="loading-placeholder">Pokémon 1</div> </div> <div class="compare-column" id="compare-col-2"> <div class="loading-placeholder">Pokémon 2</div> </div> </div> </div> </div>

    <audio id="pokemon-cry-audio" style="display: none;"></audio>

    <!-- Tooltips -->
    <div id="move-tooltip"></div>
    <div id="ability-tooltip"></div>

    <script>
        // --- Configuration, DOM Elements, State Variables ---
        const POKEMON_PER_PAGE = 50;
        const POKE_API_BASE_URL = 'https://pokeapi.co/api/v2/';
        const POKEMON_TYPES = ['normal','fire','water','electric','grass','ice','fighting','poison','ground','flying','psychic','bug','rock','ghost','dragon','dark','steel','fairy'];
        const pokedexContainer = document.getElementById('pokedex-container'); const searchInput = document.getElementById('search-input'); const typeFilter = document.getElementById('type-filter'); const sortOrder = document.getElementById('sort-order'); const loadMoreBtn = document.getElementById('load-more-btn'); const favoritesFilterBtn = document.getElementById('favorites-filter-btn'); const langSwitcherBtn = document.getElementById('lang-switcher'); const modal = document.getElementById('pokemon-modal'); const closeModalBtn = document.getElementById('close-modal'); const modalPokemonImg = document.getElementById('modal-pokemon-img'); const modalPokemonName = document.getElementById('modal-pokemon-name'); const modalPokemonId = document.getElementById('modal-pokemon-id'); const modalPokemonTypes = document.getElementById('modal-pokemon-types'); const physicalDetailsContent = document.getElementById('physical-details-content'); const trainingDetailsContent = document.getElementById('training-details-content'); const otherDetailsContent = document.getElementById('other-details-content'); const statsContent = document.getElementById('stats-content'); const weaknessContent = document.getElementById('weakness-content'); const evolutionContent = document.getElementById('evolution-content'); const flavorTextContent = document.getElementById('flavor-text-content'); const movesContent = document.getElementById('moves-content'); const legendaryMythicalBadge = document.getElementById('legendary-mythical-badge'); const playCryBtn = document.getElementById('play-cry-btn'); const pokemonCryAudio = document.getElementById('pokemon-cry-audio'); const modalTabs = document.querySelectorAll('.tab-link'); const tabContents = document.querySelectorAll('.tab-content'); const comparisonBar = document.getElementById('comparison-bar'); const comparisonSlots = document.getElementById('comparison-slots'); const compareNowBtn = document.getElementById('compare-now-btn'); const clearComparisonBtn = document.getElementById('clear-comparison-btn'); const comparisonModal = document.getElementById('comparison-modal'); const closeComparisonModalBtn = document.getElementById('close-comparison-modal'); const comparisonContainer = document.getElementById('comparison-container'); const compareCol1 = document.getElementById('compare-col-1'); const compareCol2 = document.getElementById('compare-col-2'); const moveTooltip = document.getElementById('move-tooltip'); const abilityTooltip = document.getElementById('ability-tooltip'); const wikiLink = document.getElementById('wiki-link'); // Wiki Link Ref
        let allPokemonData = []; let displayedPokemon = []; let pokemonSpeciesDataCache = {}; let evolutionChainCache = {}; let typeDataCache = {}; let moveDetailCache = {}; let abilityDetailCache = {}; let nextPokemonIdToLoad = 1; let isLoading = false; let favorites = []; let isShowingFavorites = false; let currentLanguage = localStorage.getItem('preferredLanguage') || 'vi'; let comparisonList = [];

        // --- Translation Data ---
        const translations = { pokedexTitle: { en: 'Advanced Pokédex', vi: 'Pokédex Nâng Cao' }, headerTitle: { en: 'Advanced Pokédex', vi: 'Pokédex Nâng Cao' }, headerSubtitle: { en: 'Explore the amazing Pokémon world!', vi: 'Khám phá thế giới Pokémon kỳ diệu!' }, searchPlaceholder: { en: 'Search by Name or ID...', vi: 'Tìm theo Tên hoặc ID...' }, filterByType: { en: 'Filter by Type...', vi: 'Lọc theo Hệ...' }, showFavoritesBtn: { en: 'Show Favorites', vi: 'Hiện Yêu Thích' }, showAllBtn: { en: 'Show All', vi: 'Hiện Tất Cả' }, sortById: { en: 'Sort by ID', vi: 'Sắp xếp theo ID' }, sortByName: { en: 'Sort by Name (A-Z)', vi: 'Sắp xếp theo Tên (A-Z)' }, loadMoreBtn: { en: 'Load More Pokémon', vi: 'Tải thêm Pokémon' }, loadingPokemon: { en: 'Loading Pokémon...', vi: 'Đang tải Pokémon...' }, loadingText: { en: 'Loading...', vi: 'Đang tải...' }, noPokemonFound: { en: 'No Pokémon match the current filters.', vi: 'Không tìm thấy Pokémon nào phù hợp.' }, errorLoading: { en: 'Error loading Pokémon. Please try again later.', vi: 'Lỗi tải Pokémon. Vui lòng thử lại sau.' }, tabDetails: { en: 'Details', vi: 'Chi tiết' }, tabStats: { en: 'Stats & Weaknesses', vi: 'Chỉ số & Điểm yếu' }, tabEvolution: { en: 'Evolution', vi: 'Tiến hóa' }, tabMoves: { en: 'Moves', vi: 'Tuyệt chiêu' }, tabFlavor: { en: 'Description', vi: 'Mô tả' }, sectionPhysical: { en: 'Physical Traits', vi: 'Đặc điểm Thể chất' }, sectionTrainingAndMore: { en: 'Training & Other Info', vi: 'Thông tin Huấn luyện & Khác' }, sectionStats: { en: 'Base Stats', vi: 'Chỉ số Cơ bản' }, sectionTypeMatchups: { en: 'Type Matchups', vi: 'Tương tác Hệ' }, sectionEvolution: { en: 'Evolution Chain', vi: 'Chuỗi Tiến hóa' }, sectionMoves: { en: 'Moves (Level Up)', vi: 'Tuyệt chiêu (Lên cấp)' }, sectionPokedexEntry: { en: 'Pokédex Entry', vi: 'Mô tả Pokédex' }, labelHeight: { en: 'Height', vi: 'Chiều cao' }, labelWeight: { en: 'Weight', vi: 'Cân nặng' }, labelAbilities: { en: 'Abilities', vi: 'Khả năng' }, labelBaseExp: { en: 'Base Exp', vi: 'EXP Cơ bản' }, labelGrowthRate: { en: 'Growth Rate', vi: 'Tốc độ tăng trưởng' }, labelBaseHappiness: { en: 'Base Happiness', vi: 'Hạnh phúc cơ bản' }, labelCaptureRate: { en: 'Capture Rate', vi: 'Tỷ lệ bắt' }, labelGenderRatio: { en: 'Gender Ratio', vi: 'Tỷ lệ giới tính' }, labelGeneration: { en: 'Generation', vi: 'Thế hệ' }, labelHabitat: { en: 'Habitat', vi: 'Môi trường sống' }, labelEggGroups: { en: 'Egg Groups', vi: 'Nhóm Trứng' }, genderless: { en: 'Genderless', vi: 'Vô giới tính' }, badgeLegendary: { en: 'Legendary', vi: 'Huyền thoại' }, badgeMythical: { en: 'Mythical', vi: 'Thần thoại' }, statHP: { en: 'HP', vi: 'HP' }, statAttack: { en: 'Attack', vi: 'Tấn công' }, statDefense: { en: 'Defense', vi: 'Phòng thủ' }, statSpAtk: { en: 'Sp. Atk', vi: 'T.Công Đặc biệt' }, statSpDef: { en: 'Sp. Def', vi: 'P.Thủ Đặc biệt' }, statSpeed: { en: 'Speed', vi: 'Tốc độ' }, weaknessesTitle: { en: 'Weaknesses', vi: 'Điểm yếu' }, resistancesTitle: { en: 'Resistances', vi: 'Kháng cự' }, immunitiesTitle: { en: 'Immunities', vi: 'Miễn nhiễm' }, noMatchupsFound: { en: 'No specific weaknesses or resistances found.', vi: 'Không tìm thấy điểm yếu hay kháng cự đặc biệt.' }, evolutionError: { en: 'Could not load evolution data.', vi: 'Không thể tải dữ liệu tiến hóa.' }, noEvolutionFound: { en: 'No further evolutions found.', vi: 'Không tìm thấy dạng tiến hóa nào khác.' }, noMovesFound: { en: 'No moves learned by level-up found.', vi: 'Không tìm thấy tuyệt chiêu học bằng lên cấp.' }, flavorError: { en: 'Could not load description.', vi: 'Không thể tải mô tả.' }, noFlavorText: { en: 'No description available in selected language.', vi: 'Không có mô tả bằng ngôn ngữ đã chọn.' }, playCryBtnTitle: { en: 'Play Cry', vi: 'Phát tiếng kêu' }, favActionTitle: { en: 'Toggle Favorite', vi: 'Thêm/Xóa Yêu thích'}, comparePrompt: { en: 'Select Pokémon to compare...', vi: 'Chọn Pokémon để so sánh...' }, compareNowBtn: { en: 'Compare Now!', vi: 'So sánh Ngay!' }, clearBtn: { en: 'Clear', vi: 'Xóa' }, comparisonTitle: { en: 'Pokémon Comparison', vi: 'So sánh Pokémon' }, selectTwoPrompt: { en: 'Please select two Pokémon to compare.', vi: 'Vui lòng chọn hai Pokémon để so sánh.' }, compareActionTitle: { en: 'Add/Remove from Comparison', vi: 'Thêm/Xóa khỏi So sánh'}, removeFromCompareTitle: { en: 'Remove from comparison', vi: 'Xóa khỏi so sánh'}, moveDetailPower: { en: 'Power', vi: 'Sức mạnh' }, moveDetailAccuracy: { en: 'Accuracy', vi: 'Chính xác' }, moveDetailPP: { en: 'PP', vi: 'PP' }, moveDetailType: { en: 'Type', vi: 'Hệ' }, moveDetailEffect: { en: 'Effect', vi: 'Hiệu ứng' }, moveDetailNA: { en: 'N/A', vi: 'Không có' }, moveDetailDmgClass: { en: 'Class', vi: 'Phân loại' }, moveDetailTarget: { en: 'Target', vi: 'Mục tiêu' }, abilityDescTitle: { en: 'Ability Effect', vi: 'Hiệu ứng Khả năng'}, errorLoadingAbility: { en: 'Could not load ability details.', vi: 'Không thể tải chi tiết khả năng.' }, learnMoreWiki: { en: 'Learn More on Bulbapedia', vi: 'Tìm hiểu thêm trên Bulbapedia' }, };

        // --- Type Chart Data ---
        const typeChart = { normal: { rock: 2, ghost: 3, steel: 2 }, fire: { fire: 2, water: 2, grass: 1, ice: 1, bug: 1, rock: 2, dragon: 2, steel: 1 }, water: { fire: 1, water: 2, grass: 2, ground: 1, rock: 1, dragon: 2 }, electric: { water: 1, electric: 2, grass: 2, ground: 3, flying: 1, dragon: 2 }, grass: { fire: 2, water: 1, grass: 2, poison: 2, ground: 1, flying: 2, bug: 2, rock: 1, dragon: 2, steel: 2 }, ice: { fire: 2, water: 2, grass: 1, ice: 2, ground: 1, flying: 1, dragon: 1, steel: 2 }, fighting: { normal: 1, ice: 1, poison: 2, flying: 2, psychic: 2, bug: 2, rock: 1, ghost: 3, dark: 1, steel: 1, fairy: 2 }, poison: { grass: 1, poison: 2, ground: 2, rock: 2, ghost: 2, steel: 3, fairy: 1 }, ground: { fire: 1, electric: 3, grass: 2, poison: 1, flying: 3, bug: 2, rock: 1, steel: 1 }, flying: { electric: 2, grass: 1, fighting: 1, bug: 1, rock: 2, steel: 2 }, psychic: { fighting: 1, poison: 1, psychic: 2, dark: 3, steel: 2 }, bug: { fire: 2, grass: 1, fighting: 2, poison: 2, flying: 2, psychic: 1, ghost: 2, dark: 1, steel: 2, fairy: 2 }, rock: { fire: 1, ice: 1, fighting: 2, ground: 2, flying: 1, bug: 1, steel: 2 }, ghost: { normal: 3, psychic: 1, ghost: 1, dark: 2 }, dragon: { dragon: 1, steel: 2, fairy: 3 }, dark: { fighting: 2, psychic: 1, ghost: 1, dark: 2, fairy: 2 }, steel: { fire: 2, water: 2, electric: 2, ice: 1, normal: 1, rock: 1, steel: 2, fairy: 1 }, fairy: { fire: 2, fighting: 1, poison: 2, dragon: 1, dark: 1, steel: 2 }, };

        // --- Translation Helper ---
        function getText(key) { return translations[key]?.[currentLanguage] || translations[key]?.['en'] || key; }
        function updateUIText() { document.title = getText('pokedexTitle'); document.querySelectorAll('[data-translate-key]').forEach(el => { const key = el.dataset.translateKey; const text = getText(key); if (el.placeholder !== undefined) { el.placeholder = text; } else if (el.title !== undefined && (key.endsWith('Title') || key === 'favActionTitle' || key === 'removeFromCompareTitle' || key === 'compareActionTitle')) { el.title = text; } else { el.textContent = text; } }); langSwitcherBtn.textContent = (currentLanguage === 'vi') ? 'English' : 'Tiếng Việt'; favoritesFilterBtn.textContent = isShowingFavorites ? getText('showAllBtn') : getText('showFavoritesBtn'); updateComparisonBar(); }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initializePokedex);
        async function initializePokedex() { loadFavorites(); clearComparison(); await populateTypeFilter(); updateUIText(); setupEventListeners(); await loadPokemonBatch(); }

        // --- Data Fetching ---
        async function fetchJson(url) { try { const response = await fetch(url); if (!response.ok) { throw new Error(`HTTP error! Status: ${response.status} for URL: ${url}`); } return await response.json(); } catch (error) { console.error("Fetch error:", error); return null; } }
        async function fetchPokemonData(id) { return await fetchJson(`${POKE_API_BASE_URL}pokemon/${id}`); }
        async function fetchSpeciesData(idOrUrl) { const url = typeof idOrUrl === 'string' ? idOrUrl : `${POKE_API_BASE_URL}pokemon-species/${idOrUrl}`; if (pokemonSpeciesDataCache[url]) return pokemonSpeciesDataCache[url]; const data = await fetchJson(url); if(data) pokemonSpeciesDataCache[url] = data; return data; }
        async function fetchEvolutionChain(url) { if (evolutionChainCache[url]) return evolutionChainCache[url]; const data = await fetchJson(url); if(data) evolutionChainCache[url] = data; return data; }
        async function fetchTypeData(typeName) { if (typeDataCache[typeName]) return typeDataCache[typeName]; const data = await fetchJson(`${POKE_API_BASE_URL}type/${typeName}`); if (data) typeDataCache[typeName] = data; return data; }

        // --- Pokemon Loading ---
        async function loadPokemonBatch() { if (isLoading) return; isLoading = true; loadMoreBtn.disabled = true; loadMoreBtn.textContent = getText('loadingText'); if (nextPokemonIdToLoad === 1 && pokedexContainer.children.length === 0) pokedexContainer.innerHTML = `<div class="loading"><div class="spinner"></div><p>${getText('loadingPokemon')}</p></div>`; const promises = []; const limit = nextPokemonIdToLoad + POKEMON_PER_PAGE - 1; for (let i = nextPokemonIdToLoad; i <= limit; i++) { promises.push(fetchPokemonData(i)); } try { const results = await Promise.all(promises); const newPokemon = results.filter(data => data !== null); allPokemonData.push(...newPokemon); nextPokemonIdToLoad = limit + 1; if (nextPokemonIdToLoad === POKEMON_PER_PAGE + 1 && pokedexContainer.querySelector('.loading')) { pokedexContainer.innerHTML = ''; } await renderPokedex(); } catch (error) { console.error("Error loading Pokémon batch:", error); pokedexContainer.innerHTML += `<p style="color: red; text-align: center;">${getText('errorLoading')}</p>`; } finally { isLoading = false; loadMoreBtn.disabled = false; loadMoreBtn.textContent = getText('loadMoreBtn'); } }

        // --- Rendering ---
        async function renderPokedex() { applyFiltersAndSort(); pokedexContainer.innerHTML = ''; if (displayedPokemon.length === 0 && !isLoading) { pokedexContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center;">${getText('noPokemonFound')}</p>`; loadMoreBtn.style.display = 'none'; return; } else { loadMoreBtn.style.display = 'block'; } const cardPromises = displayedPokemon.map(pokemon => createPokemonCard(pokemon)); try { const cards = await Promise.all(cardPromises); cards.forEach(card => { if (card) { pokedexContainer.appendChild(card); } }); updateFavoriteIcons(); updateAllCompareIcons(); } catch (error) { console.error("Error creating Pokémon cards:", error); pokedexContainer.innerHTML = `<p style="color: red; text-align: center;">Error displaying Pokémon cards.</p>`; } }
        async function createPokemonCard(pokemon) { const card = document.createElement('div'); card.classList.add('pokemon-card'); card.dataset.id = pokemon.id; const imageUrl = pokemon.sprites.other?.['official-artwork']?.front_default || pokemon.sprites.front_default || 'placeholder.png'; const isFav = isFavorite(pokemon.id); const isInCompare = comparisonList.includes(pokemon.id); const typePromises = pokemon.types.map(typeInfo => getTypeDisplayName(typeInfo.type.name)); const typeNames = await Promise.all(typePromises); const typesHTML = pokemon.types.map((typeInfo, index) => { const type = typeInfo.type.name; const displayName = typeNames[index]; return `<div class="pokemon-type ${type}">${displayName}</div>`; }).join(''); card.innerHTML = `<div class="card-icons"><span class="favorite-icon ${isFav ? 'favorited' : ''}" data-id="${pokemon.id}" title="${getText('favActionTitle')}">❤</span><span class="compare-icon ${isInCompare ? 'selected' : ''}" data-id="${pokemon.id}" title="${getText('compareActionTitle')}">⚖️</span></div><div class="pokemon-image"><img src="${imageUrl}" alt="${pokemon.name}" loading="lazy"></div><div class="pokemon-info"><div class="pokemon-id">#${pokemon.id.toString().padStart(3, '0')}</div><h2 class="pokemon-name">${pokemon.name}</h2><div class="pokemon-types">${typesHTML}</div></div>`; card.addEventListener('click', (event) => { if (!event.target.closest('.card-icons')) { openPokemonModal(pokemon.id); } }); const favIcon = card.querySelector('.favorite-icon'); favIcon.addEventListener('click', (event) => { event.stopPropagation(); toggleFavorite(pokemon.id); }); const compareIcon = card.querySelector('.compare-icon'); compareIcon.addEventListener('click', (event) => { event.stopPropagation(); handleCompareClick(pokemon.id); }); return card; }
        async function populateTypeFilter() { typeFilter.innerHTML = `<option value="">${getText('filterByType')}</option>`; const typePromises = POKEMON_TYPES.map(type => getTypeDisplayName(type)); const displayNames = await Promise.all(typePromises); POKEMON_TYPES.forEach((type, index) => { const option = document.createElement('option'); option.value = type; option.textContent = displayNames[index]; typeFilter.appendChild(option); }); }

        // --- Filtering & Sorting ---
        function applyFiltersAndSort() { let filteredList = [...allPokemonData]; if (isShowingFavorites) { filteredList = filteredList.filter(p => isFavorite(p.id)); } const selectedType = typeFilter.value; if (selectedType) { filteredList = filteredList.filter(p => p.types.some(t => t.type.name === selectedType)); } const searchTerm = searchInput.value.toLowerCase().trim(); if (searchTerm) { filteredList = filteredList.filter(p => p.name.toLowerCase().includes(searchTerm) || p.id.toString() === searchTerm ); } const sortBy = sortOrder.value; if (sortBy === 'name') { filteredList.sort((a, b) => a.name.localeCompare(b.name)); } else { filteredList.sort((a, b) => a.id - b.id); } displayedPokemon = filteredList; }

        // --- Event Listeners ---
        function setupEventListeners() {
            searchInput.addEventListener('input', renderPokedex); typeFilter.addEventListener('change', renderPokedex); sortOrder.addEventListener('change', renderPokedex); loadMoreBtn.addEventListener('click', loadPokemonBatch);
            closeModalBtn.addEventListener('click', () => { speechSynthesis.cancel(); hideMoveTooltip(); hideAbilityTooltip(); modal.style.display = 'none'; });
            closeComparisonModalBtn.addEventListener('click', () => {hideMoveTooltip(); hideAbilityTooltip(); comparisonModal.style.display = 'none'; });
            window.addEventListener('click', (event) => { if (event.target === modal) { speechSynthesis.cancel(); hideMoveTooltip(); hideAbilityTooltip(); modal.style.display = 'none'; } if (event.target === comparisonModal) { hideMoveTooltip(); hideAbilityTooltip(); comparisonModal.style.display = 'none'; } });
            document.addEventListener('keydown', (event) => { if (event.key === 'Escape') { if (modal.style.display === 'block') { speechSynthesis.cancel(); hideMoveTooltip(); hideAbilityTooltip(); modal.style.display = 'none'; } if (comparisonModal.style.display === 'block') { hideMoveTooltip(); hideAbilityTooltip(); comparisonModal.style.display = 'none'; } } });
            favoritesFilterBtn.addEventListener('click', () => { isShowingFavorites = !isShowingFavorites; favoritesFilterBtn.textContent = isShowingFavorites ? getText('showAllBtn') : getText('showFavoritesBtn'); favoritesFilterBtn.classList.toggle('active', isShowingFavorites); renderPokedex(); });
            langSwitcherBtn.addEventListener('click', async () => { hideMoveTooltip(); hideAbilityTooltip(); clearComparison(); currentLanguage = (currentLanguage === 'vi') ? 'en' : 'vi'; localStorage.setItem('preferredLanguage', currentLanguage); updateUIText(); await populateTypeFilter(); await renderPokedex(); const openModalElement = document.querySelector('#pokemon-modal[style*="display: block"]'); if (openModalElement) { speechSynthesis.cancel(); const pokemonId = parseInt(openModalElement.dataset.pokemonId); if (!isNaN(pokemonId)) { openPokemonModal(pokemonId); } } });
            modalTabs.forEach(tab => { tab.addEventListener('click', () => { hideMoveTooltip(); hideAbilityTooltip(); modalTabs.forEach(t => t.classList.remove('active')); tabContents.forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active'); }); });
            playCryBtn.addEventListener('click', () => { if (pokemonCryAudio.src && !pokemonCryAudio.paused) { pokemonCryAudio.pause(); pokemonCryAudio.currentTime = 0; } else if (pokemonCryAudio.src) { try{ speechSynthesis.cancel(); pokemonCryAudio.play(); } catch(e){ console.error("Audio play failed:", e); } } });
            compareNowBtn.addEventListener('click', openComparisonModal);
            clearComparisonBtn.addEventListener('click', clearComparison);
        }

        // --- TTS Setup ---
        function speakText(text, lang, rate = 1.0, pitch = 1.0) { if (!text || !('speechSynthesis' in window)) return; if (speechSynthesis.speaking) { speechSynthesis.cancel(); } setTimeout(() => { const utterance = new SpeechSynthesisUtterance(text); utterance.lang = lang; utterance.rate = rate; utterance.pitch = pitch; try { speechSynthesis.speak(utterance); } catch(e){ console.error("Speech synthesis error:", e)} }, 100); }

        // --- Modal Logic ---
        async function openPokemonModal(pokemonId) {
            modal.dataset.pokemonId = pokemonId; const pokemon = allPokemonData.find(p => p.id === pokemonId); if (!pokemon) return;
            modal.style.display = 'block'; modalTabs.forEach((t, i) => t.classList.toggle('active', t.dataset.tab === 'details')); tabContents.forEach((c, i) => c.classList.toggle('active', c.id === 'tab-details'));
            [physicalDetailsContent, trainingDetailsContent, otherDetailsContent, statsContent, weaknessContent, evolutionContent, flavorTextContent, movesContent].forEach(el => { if(el) el.innerHTML = `<span class="loading-placeholder">${getText('loadingText')}</span>`; }); pokemonCryAudio.src = ''; legendaryMythicalBadge.style.display = 'none';
            const imageUrl = pokemon.sprites.other?.['official-artwork']?.front_default || pokemon.sprites.front_default || 'placeholder.png'; modalPokemonImg.src = imageUrl; modalPokemonImg.alt = pokemon.name; modalPokemonId.textContent = `#${pokemon.id.toString().padStart(3, '0')}`;
            const speciesData = await fetchSpeciesData(pokemon.id); let displayName = pokemon.name; if (speciesData) { const localizedNameObj = speciesData.names.find(name => name.language.name === currentLanguage) || speciesData.names.find(name => name.language.name === 'en'); if (localizedNameObj) displayName = localizedNameObj.name; } modalPokemonName.textContent = displayName;
            const englishName = pokemon.name; speakText(englishName, 'en-US', 0.9); // Speak English name
            const typePromises = pokemon.types.map(typeInfo => getTypeDisplayName(typeInfo.type.name)); const typeNames = await Promise.all(typePromises); modalPokemonTypes.innerHTML = pokemon.types.map((typeInfo, index) => { const type = typeInfo.type.name; const displayTypeName = typeNames[index]; return `<div class="pokemon-type ${type}">${displayTypeName}</div>`; }).join('');
            pokemonCryAudio.src = pokemon.cries?.latest || pokemon.cries?.legacy || ''; playCryBtn.style.display = pokemonCryAudio.src ? 'block' : 'none';
            if (speciesData) { if (speciesData.is_legendary) { legendaryMythicalBadge.textContent = getText('badgeLegendary'); legendaryMythicalBadge.className = 'legendary'; legendaryMythicalBadge.style.display = 'inline-block'; } else if (speciesData.is_mythical) { legendaryMythicalBadge.textContent = getText('badgeMythical'); legendaryMythicalBadge.className = 'mythical'; legendaryMythicalBadge.style.display = 'inline-block'; } }
            displayPokemonStats(pokemon); await displayPhysicalDetails(pokemon); displayPokemonMoves(pokemon);
            if (speciesData) { displayTrainingDetails(speciesData, pokemon.base_experience); displayOtherDetails(speciesData); displayFlavorText(speciesData); await displayEvolutionChain(speciesData.evolution_chain.url); await displayWeaknesses(pokemon.types); }
            else { flavorTextContent.innerHTML = `<span class="loading-placeholder">${getText('flavorError')}</span>`; evolutionContent.innerHTML = `<span class="loading-placeholder">${getText('evolutionError')}</span>`; trainingDetailsContent.innerHTML = `<span class="loading-placeholder">${getText('loadingText')}</span>`; otherDetailsContent.innerHTML = `<span class="loading-placeholder">${getText('loadingText')}</span>`; weaknessContent.innerHTML = `<span class="loading-placeholder">${getText('loadingText')}</span>`; movesContent.innerHTML = `<span class="loading-placeholder">${getText('loadingText')}</span>`; }
             // Set Wiki Link
            if (wikiLink && pokemon) { let wikiName = pokemon.name.replace(/-[fm]$/i, (match) => (match === '-f' ? '♀' : '♂')); wikiName = wikiName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join('_'); wikiName = wikiName.replace('Mr._Mime', 'Mr._Mime'); wikiLink.href = `https://bulbapedia.bulbagarden.net/wiki/${wikiName}_(Pokémon)`; wikiLink.style.display = 'inline-block'; } else if (wikiLink) { wikiLink.style.display = 'none'; }
        }

        async function displayPhysicalDetails(pokemon) { const height = (pokemon.height / 10).toFixed(1); const weight = (pokemon.weight / 10).toFixed(1); const abilitiesHTML = pokemon.abilities.map(a => { const abilityName = a.ability.name.replace('-', ' '); const abilityUrl = a.ability.url; return `<span class="ability-name-clickable" data-ability-url="${abilityUrl}">${abilityName}</span>`; }).join(', '); physicalDetailsContent.innerHTML = `<div class="detail-row"><div class="detail-label">${getText('labelHeight')}</div><div class="detail-value">${height} m</div></div><div class="detail-row"><div class="detail-label">${getText('labelWeight')}</div><div class="detail-value">${weight} kg</div></div><div class="detail-row"><div class="detail-label">${getText('labelAbilities')}</div><div class="detail-value" style="text-transform: none;">${abilitiesHTML || getText('moveDetailNA')}</div></div>`; physicalDetailsContent.querySelectorAll('.ability-name-clickable').forEach(span => { span.addEventListener('click', handleAbilityClick); span.addEventListener('mouseout', hideAbilityTooltip); }); }
        function displayTrainingDetails(speciesData, baseExperience) { const growthRate = speciesData.growth_rate.name.replace('-', ' '); const baseHappiness = speciesData.base_happiness; const captureRate = speciesData.capture_rate; const genderRate = speciesData.gender_rate; let genderString; if (genderRate === -1) genderString = getText('genderless'); else { const femalePerc = (genderRate / 8) * 100; const malePerc = 100 - femalePerc; genderString = `♂ ${malePerc.toFixed(1)}% | ♀ ${femalePerc.toFixed(1)}%`; } trainingDetailsContent.innerHTML = `<div class="detail-row"><div class="detail-label">${getText('labelBaseExp')}</div><div class="detail-value">${baseExperience || 'N/A'}</div></div><div class="detail-row"><div class="detail-label">${getText('labelGrowthRate')}</div><div class="detail-value">${growthRate}</div></div><div class="detail-row"><div class="detail-label">${getText('labelBaseHappiness')}</div><div class="detail-value">${baseHappiness}</div></div><div class="detail-row"><div class="detail-label">${getText('labelCaptureRate')}</div><div class="detail-value">${captureRate}</div></div><div class="detail-row"><div class="detail-label">${getText('labelGenderRatio')}</div><div class="detail-value" style="text-transform: none;">${genderString}</div></div>`; }
        function displayOtherDetails(speciesData) { const generation = speciesData.generation?.name.replace('generation-', '').toUpperCase() || getText('moveDetailNA'); const habitat = speciesData.habitat?.name.replace('-', ' ') || getText('moveDetailNA'); const eggGroups = speciesData.egg_groups?.map(eg => eg.name.replace('-', ' ')).join(', ') || getText('moveDetailNA'); otherDetailsContent.innerHTML = `<div class="detail-row"><div class="detail-label">${getText('labelGeneration')}</div><div class="detail-value">${generation}</div></div><div class="detail-row"><div class="detail-label">${getText('labelHabitat')}</div><div class="detail-value">${habitat}</div></div><div class="detail-row"><div class="detail-label">${getText('labelEggGroups')}</div><div class="detail-value">${eggGroups}</div></div>`; }
        function displayPokemonStats(pokemon) { statsContent.innerHTML = pokemon.stats.map(stat => { const statName = stat.stat.name; const statValue = stat.base_stat; const maxStat = getMaxStatValue(statName); const percentage = Math.min(100, (statValue / maxStat) * 100); let formattedNameKey; switch (statName) { case 'hp': formattedNameKey = 'statHP'; break; case 'attack': formattedNameKey = 'statAttack'; break; case 'defense': formattedNameKey = 'statDefense'; break; case 'special-attack': formattedNameKey = 'statSpAtk'; break; case 'special-defense': formattedNameKey = 'statSpDef'; break; case 'speed': formattedNameKey = 'statSpeed'; break; default: formattedNameKey = statName; } const formattedName = getText(formattedNameKey); const statClass = statName.replace('special-', 'special_'); return `<div class="stat-bar"><div class="stat-name"><span>${formattedName}</span><span>${statValue}</span></div><div class="progress-bar"><div class="progress ${statClass}" style="width: ${percentage}%"></div></div></div>`; }).join(''); }
        async function displayWeaknesses(types) { const typeNames = types.map(t => t.type.name); const multipliers = {}; POKEMON_TYPES.forEach(attackingType => { let finalMultiplier = 1; typeNames.forEach(defendingType => { const interaction = typeChart[attackingType]?.[defendingType]; switch (interaction) { case 1: finalMultiplier *= 2; break; case 2: finalMultiplier *= 0.5; break; case 3: finalMultiplier = 0; break; default: break; } }); if (finalMultiplier !== 1) { multipliers[attackingType] = finalMultiplier; } }); const weaknesses = Object.entries(multipliers).filter(([_, m]) => m > 1).sort((a, b) => b[1] - a[1]); const resistances = Object.entries(multipliers).filter(([_, m]) => m < 1 && m > 0).sort((a, b) => a[1] - b[1]); const immunities = Object.entries(multipliers).filter(([_, m]) => m === 0).sort(); const getTypeBadgeHTML = async (typeArray, titleKey) => { if (typeArray.length === 0) return ''; const typePromises = typeArray.map(([type, multi]) => getTypeDisplayName(type).then(name => ({ name, type, multi }))); const localizedTypes = await Promise.all(typePromises); const multiplierText = localizedTypes.map(t => `x${t.multi}`).filter((v, i, a) => a.indexOf(v) === i).join(', '); return `<div class="weakness-section"><h4>${getText(titleKey)} ${multiplierText ? `(${multiplierText})` : ''}</h4><div class="weakness-types">` + localizedTypes.map(t => `<div class="pokemon-type ${t.type}">${t.name}</div>`).join('') + `</div></div>`; }; let html = ''; html += await getTypeBadgeHTML(weaknesses, 'weaknessesTitle'); html += await getTypeBadgeHTML(resistances, 'resistancesTitle'); html += await getTypeBadgeHTML(immunities, 'immunitiesTitle'); weaknessContent.innerHTML = html || `<span class="loading-placeholder">${getText('noMatchupsFound')}</span>`; }
        async function displayEvolutionChain(url) { const chainData = await fetchEvolutionChain(url); if (!chainData || !chainData.chain) { evolutionContent.innerHTML = `<span class="loading-placeholder">${getText('evolutionError')}</span>`; return; } evolutionContent.innerHTML = ''; let currentStageData = chainData.chain; let isFirst = true; let stageCount = 0; while (currentStageData) { stageCount++; if (!isFirst) { const arrow = document.createElement('div'); arrow.classList.add('evolution-arrow'); arrow.innerHTML = '➔'; evolutionContent.appendChild(arrow); } const stageDiv = document.createElement('div'); stageDiv.classList.add('evolution-stage'); const pokemonName = currentStageData.species.name; const pokemonIdMatch = currentStageData.species.url.match(/\/(\d+)\/$/); const pokemonId = pokemonIdMatch ? parseInt(pokemonIdMatch[1]) : null; let pokemonInfo = allPokemonData.find(p => p.id === pokemonId); if (!pokemonInfo && pokemonId) { pokemonInfo = await fetchPokemonData(pokemonId); } const imageUrl = pokemonInfo?.sprites?.other?.['official-artwork']?.front_default || pokemonInfo?.sprites?.front_default || 'placeholder.png'; stageDiv.innerHTML = `<img src="${imageUrl}" alt="${pokemonName}" loading="lazy"><p>${pokemonName}</p><div class="evolution-detail">${getEvolutionDetails(currentStageData.evolution_details)}</div>`; if(pokemonId && pokemonInfo) { stageDiv.addEventListener('click', () => { speechSynthesis.cancel(); openPokemonModal(pokemonId); }); } evolutionContent.appendChild(stageDiv); isFirst = false; currentStageData = currentStageData.evolves_to.length > 0 ? currentStageData.evolves_to[0] : null; } if (stageCount <= 1 && evolutionContent.children.length > 0) { evolutionContent.innerHTML += `<p class="loading-placeholder" style="grid-column: 1 / -1; text-align: center; margin-top: 15px;">${getText('noEvolutionFound')}</p>`; } else if (evolutionContent.children.length === 0) { evolutionContent.innerHTML = `<span class="loading-placeholder">${getText('evolutionError')}</span>`; } }
        function getEvolutionDetails(detailsArray) { if (!detailsArray || detailsArray.length === 0) return ''; const details = detailsArray[0]; let str = ''; if (details.min_level) str += `Lv ${details.min_level}`; if (details.item) str += ` ${str ? '+' : ''} Use ${details.item.name.replace('-', ' ')}`; if (details.trigger?.name === 'trade') str += `${str ? '+' : ''} Trade`; if (details.min_happiness) str += `${str ? '+' : ''} High Happiness`; if (details.known_move_type) str += `${str ? '+' : ''} Knows ${details.known_move_type.name} move`; return str ? `${str}` : ''; }
        function displayFlavorText(speciesData) { const langEntry = speciesData.flavor_text_entries.slice().reverse().find( entry => entry.language.name === currentLanguage ); const englishEntry = speciesData.flavor_text_entries.slice().reverse().find( entry => entry.language.name === 'en' ); const entryToDisplay = langEntry || englishEntry; flavorTextContent.textContent = entryToDisplay ? entryToDisplay.flavor_text.replace(/[\n\f]/g, ' ') : getText('noFlavorText'); }
        function displayPokemonMoves(pokemon) { const levelUpMoves = []; pokemon.moves.forEach(moveData => { moveData.version_group_details.forEach(detail => { if (detail.move_learn_method.name === 'level-up' && detail.level_learned_at > 0) { const existingMove = levelUpMoves.find(m => m.name === moveData.move.name); if (existingMove) { if (detail.level_learned_at < existingMove.level) { existingMove.level = detail.level_learned_at; } } else { levelUpMoves.push({ name: moveData.move.name, level: detail.level_learned_at }); } } }); }); levelUpMoves.sort((a, b) => a.level - b.level); if (levelUpMoves.length === 0) { movesContent.innerHTML = `<p class="no-moves-found">${getText('noMovesFound')}</p>`; return; } const getMoveUrl = (moveName) => { const moveEntry = pokemon.moves.find(m => m.move.name === moveName); return moveEntry ? moveEntry.move.url : null; }; const movesHTML = levelUpMoves.map(move => { const moveUrl = getMoveUrl(move.name); return `<li class="move-item" ${moveUrl ? `data-move-url="${moveUrl}"` : ''}><span class="move-name">${move.name.replace('-', ' ')}</span><span class="move-level">Lv. ${move.level}</span></li>`; }).join(''); movesContent.innerHTML = `<ul class="moves-list">${movesHTML}</ul>`; const movesListElement = movesContent.querySelector('.moves-list'); if (movesListElement) { movesListElement.addEventListener('click', handleMoveClick); movesListElement.addEventListener('mouseout', hideMoveTooltip); } }

        // --- Favorites Logic ---
        function loadFavorites() { try { favorites = JSON.parse(localStorage.getItem('pokemonFavorites') || '[]'); if (!Array.isArray(favorites)) { favorites = []; } } catch(e) { console.error("Error loading favorites:", e); favorites = []; } }
        function saveFavorites() { localStorage.setItem('pokemonFavorites', JSON.stringify(favorites)); }
        function isFavorite(id) { return favorites.includes(id); }
        function toggleFavorite(id) { const index = favorites.indexOf(id); if (index > -1) { favorites.splice(index, 1); } else { favorites.push(id); } saveFavorites(); updateFavoriteIcon(id); if(isShowingFavorites) renderPokedex(); }
        function updateFavoriteIcon(id) { const icon = document.querySelector(`.favorite-icon[data-id="${id}"]`); if (icon) { icon.classList.toggle('favorited', isFavorite(id)); icon.title = getText('favActionTitle'); } }
        function updateFavoriteIcons() { document.querySelectorAll('.favorite-icon').forEach(icon => { const id = parseInt(icon.dataset.id); if(!isNaN(id)) updateFavoriteIcon(id); }); }

        // --- Comparison Logic ---
        function handleCompareClick(pokemonId) { const index = comparisonList.indexOf(pokemonId); if (index > -1) { comparisonList.splice(index, 1); } else { if (comparisonList.length >= 2) { const removedId = comparisonList.shift(); updateCompareIconState(removedId, false); } comparisonList.push(pokemonId); } updateComparisonBar(); updateCompareIconState(pokemonId, comparisonList.includes(pokemonId)); }
        function updateComparisonBar() { comparisonSlots.innerHTML = ''; let slotsFilled = 0; if (comparisonList.length === 0) { comparisonBar.classList.remove('visible'); return; } comparisonBar.classList.add('visible'); comparisonList.forEach(id => { const pokemon = allPokemonData.find(p => p.id === id); if (pokemon) { slotsFilled++; const slotItem = document.createElement('div'); slotItem.classList.add('comparison-slot-item'); slotItem.dataset.id = id; slotItem.title = getText('removeFromCompareTitle'); const imageUrl = pokemon.sprites.front_default || 'placeholder.png'; slotItem.innerHTML = `<img src="${imageUrl}" alt="${pokemon.name}"><span>${pokemon.name}</span>`; slotItem.addEventListener('click', () => { handleCompareClick(id); }); comparisonSlots.appendChild(slotItem); } }); if (slotsFilled < 2) { const placeholder = document.createElement('span'); placeholder.style.opacity = '0.6'; placeholder.style.fontSize = '0.9em'; placeholder.textContent = getText('comparePrompt'); if (slotsFilled === 0) { comparisonSlots.appendChild(placeholder); } } compareNowBtn.disabled = comparisonList.length !== 2; }
        function updateCompareIconState(pokemonId, isSelected) { const icon = document.querySelector(`.compare-icon[data-id="${pokemonId}"]`); if (icon) { icon.classList.toggle('selected', isSelected); icon.title = getText('compareActionTitle'); } }
        function updateAllCompareIcons() { document.querySelectorAll('.compare-icon').forEach(icon => { const id = parseInt(icon.dataset.id); if(!isNaN(id)) updateCompareIconState(id, comparisonList.includes(id)); }); }
        function clearComparison() { comparisonList = []; updateComparisonBar(); updateAllCompareIcons(); }
        async function openComparisonModal() { if (comparisonList.length !== 2) { alert(getText('selectTwoPrompt')); return; } compareCol1.innerHTML = `<div class="loading"><div class="spinner"></div></div>`; compareCol2.innerHTML = `<div class="loading"><div class="spinner"></div></div>`; comparisonModal.style.display = 'block'; try { const [pokemon1Id, pokemon2Id] = comparisonList; let pokemon1 = allPokemonData.find(p => p.id === pokemon1Id) || await fetchPokemonData(pokemon1Id); let pokemon2 = allPokemonData.find(p => p.id === pokemon2Id) || await fetchPokemonData(pokemon2Id); if (!pokemon1 || !pokemon2) throw new Error("Failed to load Pokémon data for comparison."); await populateCompareColumn(pokemon1, compareCol1); await populateCompareColumn(pokemon2, compareCol2); } catch (error) { console.error("Error opening comparison modal:", error); comparisonContainer.innerHTML = `<p style="color: red; text-align: center; grid-column: 1 / -1;">${getText('errorLoading')}</p>`; } }
        async function populateCompareColumn(pokemon, columnElement) { const imageUrl = pokemon.sprites.other?.['official-artwork']?.front_default || pokemon.sprites.front_default || 'placeholder.png'; const typePromises = pokemon.types.map(typeInfo => getTypeDisplayName(typeInfo.type.name)); const typeNames = await Promise.all(typePromises); const typesHTML = pokemon.types.map((typeInfo, index) => `<div class="pokemon-type ${typeInfo.type.name}">${typeNames[index]}</div>`).join(''); const statsHTML = pokemon.stats.map(stat => { const statName = stat.stat.name; const statValue = stat.base_stat; const maxStat = getMaxStatValue(statName); const percentage = Math.min(100, (statValue / maxStat) * 100); let formattedNameKey; switch (statName) { case 'hp': formattedNameKey = 'statHP'; break; case 'attack': formattedNameKey = 'statAttack'; break; case 'defense': formattedNameKey = 'statDefense'; break; case 'special-attack': formattedNameKey = 'statSpAtk'; break; case 'special-defense': formattedNameKey = 'statSpDef'; break; case 'speed': formattedNameKey = 'statSpeed'; break; default: formattedNameKey = statName; } const formattedName = getText(formattedNameKey); const statClass = statName.replace('special-', 'special_'); return `<div class="stat-bar"><div class="stat-name"><span>${formattedName}</span><span>${statValue}</span></div><div class="progress-bar"><div class="progress ${statClass}" style="width: ${percentage}%"></div></div></div>`; }).join(''); columnElement.innerHTML = `<div class="compare-header"><img src="${imageUrl}" alt="${pokemon.name}"><h3>${pokemon.name}</h3><div class="pokemon-id">#${pokemon.id.toString().padStart(3, '0')}</div><div class="pokemon-types">${typesHTML}</div></div><div class="stats-container"><h4 class="modal-section-title">${getText('sectionStats')}</h4>${statsHTML}</div><div class="details-container" style="margin-top: 20px;"><h4 class="modal-section-title">${getText('sectionPhysical')}</h4><div class="detail-row"><div class="detail-label">${getText('labelHeight')}</div><div class="detail-value">${(pokemon.height / 10).toFixed(1)} m</div></div><div class="detail-row"><div class="detail-label">${getText('labelWeight')}</div><div class="detail-value">${(pokemon.weight / 10).toFixed(1)} kg</div></div></div>`; }

        // --- Move Tooltip Logic ---
        async function handleMoveClick(event) { const moveItem = event.target.closest('.move-item'); if (!moveItem || !moveItem.dataset.moveUrl) { hideMoveTooltip(); return; } const moveUrl = moveItem.dataset.moveUrl; try { let moveData = moveDetailCache[moveUrl]; if (!moveData) { moveTooltip.innerHTML = `<h4>${getText('loadingText')}</h4>`; showMoveTooltip(event.clientX, event.clientY); moveData = await fetchJson(moveUrl); if (moveData) { moveDetailCache[moveUrl] = moveData; } else { moveTooltip.innerHTML = `<h4>Error</h4><p>Could not load move details.</p>`; showMoveTooltip(event.clientX, event.clientY); return; } } const damageClass = moveData.damage_class?.name || getText('moveDetailNA'); const target = moveData.target?.name?.replace('-', ' ') || getText('moveDetailNA'); let effectText = getText('moveDetailNA'); const effectEntry = moveData.effect_entries?.find(e => e.language.name === currentLanguage) || moveData.effect_entries?.find(e => e.language.name === 'en'); if(effectEntry) { effectText = effectEntry.short_effect.replace(/\$effect_chance/g, moveData.effect_chance || ''); } let localizedMoveName = moveData.name; const nameEntry = moveData.names?.find(n => n.language.name === currentLanguage) || moveData.names?.find(n => n.language.name === 'en'); if(nameEntry) localizedMoveName = nameEntry.name; const typeName = moveData.type.name; const displayTypeName = await getTypeDisplayName(typeName); moveTooltip.innerHTML = `<h4>${localizedMoveName}</h4><p><strong>${getText('moveDetailType')}:</strong> <span class="pokemon-type ${typeName}">${displayTypeName}</span></p><p><strong>${getText('moveDetailDmgClass')}:</strong> <span style="text-transform: capitalize;">${damageClass}</span></p><p><strong>${getText('moveDetailPower')}:</strong> ${moveData.power !== null ? moveData.power : getText('moveDetailNA')}</p><p><strong>${getText('moveDetailAccuracy')}:</strong> ${moveData.accuracy !== null ? moveData.accuracy + '%' : getText('moveDetailNA')}</p><p><strong>${getText('moveDetailPP')}:</strong> ${moveData.pp !== null ? moveData.pp : getText('moveDetailNA')}</p><p><strong>${getText('moveDetailTarget')}:</strong> <span style="text-transform: capitalize;">${target}</span></p><p><strong>${getText('moveDetailEffect')}:</strong> ${effectText}</p>`; showMoveTooltip(event.clientX, event.clientY); } catch (error) { console.error("Error fetching or displaying move details:", error); moveTooltip.innerHTML = `<h4>Error</h4><p>Could not load details.</p>`; showMoveTooltip(event.clientX, event.clientY); } }
        function showMoveTooltip(x, y) { if (!moveTooltip) return; moveTooltip.style.display = 'block'; let top = y + 15; let left = x + 10; const tooltipRect = moveTooltip.getBoundingClientRect(); const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight; if (left + tooltipRect.width > viewportWidth - 10) { left = x - tooltipRect.width - 10; } if (top + tooltipRect.height > viewportHeight - 10) { top = y - tooltipRect.height - 15; } if (left < 10) left = 10; if (top < 10) top = 10; moveTooltip.style.left = `${left}px`; moveTooltip.style.top = `${top}px`; }
        function hideMoveTooltip() { if (moveTooltip) { moveTooltip.style.display = 'none'; } }

        // --- Ability Tooltip Logic ---
        async function handleAbilityClick(event) { const abilitySpan = event.target.closest('.ability-name-clickable'); if (!abilitySpan || !abilitySpan.dataset.abilityUrl) { hideAbilityTooltip(); return; } const abilityUrl = abilitySpan.dataset.abilityUrl; const abilityNameFromSpan = abilitySpan.textContent; try { let abilityData = abilityDetailCache[abilityUrl]; if (!abilityData) { abilityTooltip.innerHTML = `<h4>${getText('loadingText')}</h4>`; showAbilityTooltip(event.clientX, event.clientY); abilityData = await fetchJson(abilityUrl); if (abilityData) { abilityDetailCache[abilityUrl] = abilityData; } else { throw new Error("Failed to fetch ability data"); } } let localizedAbilityName = abilityNameFromSpan; const nameEntry = abilityData.names?.find(n => n.language.name === currentLanguage) || abilityData.names?.find(n => n.language.name === 'en'); if(nameEntry) localizedAbilityName = nameEntry.name; let effectText = getText('noFlavorText'); const effectEntry = abilityData.effect_entries?.find(e => e.language.name === currentLanguage) || abilityData.effect_entries?.find(e => e.language.name === 'en'); if (effectEntry) { effectText = effectEntry.effect; } abilityTooltip.innerHTML = `<h4>${localizedAbilityName}</h4><p>${effectText}</p>`; showAbilityTooltip(event.clientX, event.clientY); } catch (error) { console.error("Error fetching or displaying ability details:", error); abilityTooltip.innerHTML = `<h4>Error</h4><p>${getText('errorLoadingAbility')}</p>`; showAbilityTooltip(event.clientX, event.clientY); } }
        function showAbilityTooltip(x, y) { if (!abilityTooltip) return; abilityTooltip.style.display = 'block'; let top = y + 15; let left = x + 10; const tooltipRect = abilityTooltip.getBoundingClientRect(); const viewportWidth = window.innerWidth; const viewportHeight = window.innerHeight; if (left + tooltipRect.width > viewportWidth - 10) { left = x - tooltipRect.width - 10; } if (top + tooltipRect.height > viewportHeight - 10) { top = y - tooltipRect.height - 15; } if (left < 10) left = 10; if (top < 10) top = 10; abilityTooltip.style.left = `${left}px`; abilityTooltip.style.top = `${top}px`; }
        function hideAbilityTooltip() { if (abilityTooltip) { abilityTooltip.style.display = 'none'; } }

        // --- Utility Functions ---
        async function getTypeDisplayName(typeName) { const typeData = await fetchTypeData(typeName); if (typeData) { const localizedName = typeData.names.find(n => n.language.name === currentLanguage) || typeData.names.find(n => n.language.name === 'en'); if (localizedName) return localizedName.name; } return typeName; }
        function getMaxStatValue(statName) { const maxValues = { hp: 255, attack: 190, defense: 230, 'special-attack': 194, 'special-defense': 230, speed: 180 }; return maxValues[statName] || 200; }

    </script>
</body>
</html>